<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    collection, 
    getDocs, 
    doc, 
    getDoc, 
    addDoc, 
    deleteDoc 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const nicknameEl = document.querySelector(".nickname");
  const pointsEl = document.querySelector(".points");
  const logoutBtn = document.querySelector(".logout");
  const questionList = document.getElementById("questionList");

  const input = document.getElementById("questionInput");
  const submitBtn = document.getElementById("submitQuestion");

  // ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/sbh_qna/login.html";
      return;
    }

    // ğŸ‘¤ ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const data = userSnap.data();
      nicknameEl.innerText = data.nickname;
      pointsEl.innerText = data.points + "P";
    }

    loadQuestions();
  });

  // ğŸ“„ ì§ˆë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadQuestions() {
    const querySnapshot = await getDocs(collection(db, "questions"));

    questionList.innerHTML = "";

    querySnapshot.forEach((questionDoc) => {
      const data = questionDoc.data();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="card-title">${data.title}</div>
        <div class="card-meta">
          ì‘ì„±ì: ${data.nickname} | ë‹µë³€ ${data.answerCount || 0}ê°œ
        </div>
      `;

      // ğŸ”¥ ë‚´ê°€ ì‘ì„±í•œ ê¸€ì´ë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (auth.currentUser && auth.currentUser.uid === data.uid) {
        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "ì‚­ì œ";
        deleteBtn.style.marginTop = "8px";
        deleteBtn.style.padding = "4px 8px";
        deleteBtn.style.cursor = "pointer";

        deleteBtn.addEventListener("click", async () => {
          await deleteDoc(doc(db, "questions", questionDoc.id));
          loadQuestions();
        });

        card.appendChild(deleteBtn);
      }

      questionList.appendChild(card);
    });
  }

  // âœ ì§ˆë¬¸ ë“±ë¡
  submitBtn.addEventListener("click", async () => {
    const title = input.value.trim();

    if (!title) {
      alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    const user = auth.currentUser;

    if (!user) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    await addDoc(collection(db, "questions"), {
      title: title,
      nickname: nicknameEl.innerText,
      answerCount: 0,
      uid: user.uid   // ğŸ”¥ ì‘ì„±ì ê¸°ë¡
    });

    input.value = "";
    loadQuestions();
  });

  // ğŸšª ë¡œê·¸ì•„ì›ƒ
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "/sbh_qna/login.html";
  });
</script>
