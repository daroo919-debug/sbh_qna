<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    input { width: 100%; padding: 10px; margin-bottom: 10px; }
    button { padding: 10px 20px; cursor: pointer; }
    .error { color: red; }
  </style>
</head>
<body>

<h2>회원가입</h2>

<input id="email" placeholder="이메일 입력">
<input id="password" type="password" placeholder="비밀번호 (6자리 이상)">
<input id="nickname" placeholder="닉네임">
<input id="realname" placeholder="본명">
<input id="studentid" placeholder="학번">

<p class="error" id="errorMsg"></p>

<button onclick="handleSignUp()">회원가입</button>
<p><a href="login.html">로그인으로 이동</a></p>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { doc, setDoc, query, getDocs, collection, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  async function handleSignUp() {
    const errorMsg = document.getElementById("errorMsg");
    errorMsg.innerText = "";

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const nickname = document.getElementById("nickname").value.trim();
    const realname = document.getElementById("realname").value.trim();
    const studentid = document.getElementById("studentid").value.trim();

    if (!email || !password || !nickname || !realname || !studentid) {
      errorMsg.innerText = "모든 항목을 입력해주세요.";
      return;
    }
    if (password.length < 6) {
      errorMsg.innerText = "비밀번호는 최소 6자리 이상이어야 합니다.";
      return;
    }

    try {
      // 닉네임 중복 체크
      const q = query(collection(db, "users"),
        where("nicknameLower", "==", nickname.toLowerCase())
      );
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        errorMsg.innerText = "이미 사용 중인 닉네임입니다.";
        return;
      }

      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      await setDoc(doc(db, "users", uid), {
        email,
        nickname,
        nicknameLower: nickname.toLowerCase(),
        realName: realname,
        studentId: studentid,
        points: 0,
        nicknameHistory: [nickname],
        role: "student",
        createdAt: new Date().toISOString()
      });

      alert("회원가입 완료! 자동 로그인 후 메인 화면으로 이동합니다.");

      window.location.href = "main.html";

    } catch (err) {
      errorMsg.innerText = err.message;
    }
  }
</script>

</body>
</html>
